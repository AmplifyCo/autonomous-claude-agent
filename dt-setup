#!/bin/bash
# Digital Twin Configuration Command
# Handles full setup: dependencies + configuration
#
# Usage:
#   dt-setup                # Full setup wizard
#   dt-setup core           # Configure API keys
#   dt-setup telegram       # Configure Telegram
#   dt-setup email          # Configure email
#   dt-setup calendar       # Configure calendar
#   dt-setup digital-twin   # Full setup (alias)

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGURE_PY="$SCRIPT_DIR/configure.py"
REQUIREMENTS_TXT="$SCRIPT_DIR/requirements.txt"

# Check if configure.py exists
if [ ! -f "$CONFIGURE_PY" ]; then
    echo "Error: configure.py not found at $CONFIGURE_PY"
    exit 1
fi

# ============================================
# Auto-install dependencies if needed
# ============================================
check_and_install_dependencies() {
    # Check if anthropic package is installed (key dependency)
    if ! python3 -c "import anthropic" 2>/dev/null; then
        echo ""
        echo "üì¶ Dependencies not found. Installing required packages..."
        echo ""

        # Check if requirements.txt exists
        if [ ! -f "$REQUIREMENTS_TXT" ]; then
            echo "‚ö†Ô∏è  Warning: requirements.txt not found at $REQUIREMENTS_TXT"
            echo "   Skipping dependency installation."
            echo ""
            return
        fi

        # Install dependencies
        echo "Running: pip install -r requirements.txt"
        echo ""

        if python3 -m pip install -r "$REQUIREMENTS_TXT"; then
            echo ""
            echo "‚úÖ Dependencies installed successfully!"
            echo ""
        else
            echo ""
            echo "‚ùå Failed to install dependencies."
            echo "   Please run manually: pip install -r requirements.txt"
            echo ""
            exit 1
        fi
    fi
}

# Check dependencies before running configuration (unless --help)
if [[ "$1" != "--help" && "$1" != "-h" && "$1" != "help" ]]; then
    check_and_install_dependencies
fi

# Parse arguments and map to configure.py flags
case "$1" in
    "")
        # No arguments - run full wizard
        python3 "$CONFIGURE_PY"
        ;;
    "digital-twin"|"all"|"full")
        # Full setup
        python3 "$CONFIGURE_PY"
        ;;
    "core"|"api"|"keys")
        # Core API keys
        python3 "$CONFIGURE_PY" --core-only
        ;;
    "telegram"|"tg")
        # Telegram bot
        python3 "$CONFIGURE_PY" --telegram-only
        ;;
    "email"|"mail")
        # Email configuration
        python3 "$CONFIGURE_PY" --email-only
        ;;
    "calendar"|"cal")
        # Calendar configuration
        python3 "$CONFIGURE_PY" --calendar-only
        ;;
    "--help"|"-h"|"help")
        # Show help
        cat << EOF
Digital Twin Setup Tool

ONE command for complete setup:
  ‚Ä¢ Checks and installs dependencies (pip packages)
  ‚Ä¢ Runs interactive configuration wizard
  ‚Ä¢ Auto-detects email providers
  ‚Ä¢ Updates .env file

Usage:
  dt-setup                Full setup wizard (all tools)
  dt-setup digital-twin   Full setup (alias)
  dt-setup core           Configure API keys only
  dt-setup telegram       Configure Telegram bot only
  dt-setup email          Configure email only
  dt-setup calendar       Configure calendar only

Aliases:
  digital-twin, all, full ‚Üí Full setup
  core, api, keys         ‚Üí Core API configuration
  telegram, tg            ‚Üí Telegram configuration
  email, mail             ‚Üí Email configuration
  calendar, cal           ‚Üí Calendar configuration

Examples:
  dt-setup                # Full wizard (auto-installs deps if needed)
  dt-setup email          # Just configure email
  dt-setup core           # Just update API keys

First-time setup:
  git clone <repo>
  cd digital-twin
  make install            # Install dt-setup globally (one-time)
  dt-setup                # Installs deps + configures everything!

For advanced options, use:
  python3 configure.py --help

EOF
        ;;
    *)
        # Unknown argument - pass through to configure.py
        python3 "$CONFIGURE_PY" "$@"
        ;;
esac
